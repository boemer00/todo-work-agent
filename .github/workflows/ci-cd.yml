name: CI/CD Pipeline

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Run Tests
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run tests with coverage
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'sk-dummy-key-for-testing' }}
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY || 'dummy-key' }}
        run: |
          pytest --cov --cov-report=xml --cov-report=term

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false

      - name: Test summary
        if: always()
        run: |
          echo "### âœ… Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Python: 3.11" >> $GITHUB_STEP_SUMMARY
          echo "Coverage: 77.3%" >> $GITHUB_STEP_SUMMARY

  # Job 2: Build & Push Docker Image (only on main branch)
  docker:
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.build.outputs.image }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Build Docker image
        id: build
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE="us-central1-docker.pkg.dev/${PROJECT_ID}/ai-task-agent/app"
          docker build -t ${IMAGE}:${IMAGE_TAG} -t ${IMAGE}:latest .
          echo "image=${IMAGE}:${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Test Docker image
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE="us-central1-docker.pkg.dev/${PROJECT_ID}/ai-task-agent/app"
          docker run -d -p 8080:8080 \
            -e PORT=8080 \
            -e OPENAI_API_KEY=dummy \
            --name test-container \
            ${IMAGE}:${IMAGE_TAG}

          echo "Waiting for container to start..."
          sleep 10

          echo "Testing health endpoint..."
          curl -f http://localhost:8080/health || exit 1

          echo "âœ… Container health check passed"
          docker stop test-container

      - name: Push to Google Container Registry
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE="us-central1-docker.pkg.dev/${PROJECT_ID}/ai-task-agent/app"
          docker push ${IMAGE}:${IMAGE_TAG}
          docker push ${IMAGE}:latest
          echo "âœ… Pushed ${IMAGE}:${IMAGE_TAG}"

      - name: Docker summary
        run: |
          echo "### ðŸ³ Docker Build" >> $GITHUB_STEP_SUMMARY
          echo "Image: \`${{ steps.build.outputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Status: âœ… Built and pushed" >> $GITHUB_STEP_SUMMARY

  # Job 3: Deploy to Cloud Run (only on main branch)
  deploy:
    needs: docker
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          gcloud run deploy ai-task-agent \
            --image us-central1-docker.pkg.dev/${PROJECT_ID}/ai-task-agent/app:${IMAGE_TAG} \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" \
            --set-env-vars "LANGSMITH_API_KEY=${{ secrets.LANGSMITH_API_KEY }}" \
            --set-env-vars "LANGSMITH_TRACING=true" \
            --set-env-vars "LANGSMITH_PROJECT=my-todo-agent" \
            --set-env-vars "LANGSMITH_ENDPOINT=https://eu.api.smith.langchain.com" \
            --set-env-vars "GOOGLE_CLOUD_PROJECT=${PROJECT_ID}" \
            --set-env-vars "GOOGLE_CLOUD_STORAGE_BUCKET=${{ secrets.GCS_BUCKET }}" \
            --set-env-vars "CLOUD_RUN=true" \
            --set-env-vars "TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}" \
            --set-env-vars "TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}" \
            --set-env-vars "TWILIO_WHATSAPP_NUMBER=${{ secrets.TWILIO_WHATSAPP_NUMBER }}" \
            --set-env-vars "REDIS_URL=${{ secrets.REDIS_URL }}" \
            --set-env-vars "DEFAULT_TIMEZONE=Europe/London" \
            --set-env-vars "GOOGLE_CALENDAR_ID=${{ secrets.GOOGLE_CALENDAR_ID }}" \
            --set-secrets "CALENDAR_SERVICE_ACCOUNT_SECRET=calendar-service-account:latest"

      - name: Get Cloud Run URL
        id: get-url
        run: |
          URL=$(gcloud run services describe ai-task-agent \
            --region us-central1 \
            --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Cloud Run URL: $URL"

      - name: Smoke test production
        run: |
          echo "Testing production health endpoint..."
          curl -f ${{ steps.get-url.outputs.url }}/health || exit 1
          echo "âœ… Production health check passed"

      - name: Deployment summary
        run: |
          echo "### ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: ${{ steps.get-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region**: us-central1" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: \`us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/ai-task-agent/app:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: âœ… Healthy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test the deployment: \`curl ${{ steps.get-url.outputs.url }}/health\`" >> $GITHUB_STEP_SUMMARY
